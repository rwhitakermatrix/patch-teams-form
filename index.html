<!DOCTYPE html>
<html>
<head>
  <title>PATCH Form Debug3</title>
  <meta charset="UTF-8" />
  <script src="https://statics.teams.cdn.office.net/sdk/v1.13.0/js/MicrosoftTeams.min.js"></script>
  <style>
    html, body, iframe {
      margin: 0; padding: 0; width: 100%; height: 100%; border: none;
    }
  </style>
</head>
<body>
  <div id="status">Loading Teams SDK...</div>
  <script>
    // Initialize the Teams app
    function initializeTeamsApp() {
      // Check if Teams SDK is loaded
      if (typeof microsoftTeams === 'undefined') {
        document.getElementById('status').textContent = 'Teams SDK not loaded';
        return;
      }

      try {
        // Initialize Teams SDK
        microsoftTeams.initialize();
        
        // Get context
        document.getElementById('status').textContent = 'Getting context...';
        
        // Get user context
        microsoftTeams.app.getContext().then((context) => {
          // Get user information
          const user = context.user || {};
          const email = encodeURIComponent(user.userPrincipalName || '');
          const first = encodeURIComponent(user.givenName || '');
          const last = encodeURIComponent(user.surname || '');

          // Load form
          const url = `https://share.hsforms.com/1o9R-MCZ1S_iDscHC7T7krQc31ye?email=${email}&firstname=${first}&lastname=${last}`;
          const iframe = document.createElement('iframe');
          iframe.src = url;
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';

          document.body.innerHTML = ''; // Clear status
          document.body.appendChild(iframe);
        }).catch((err) => {
          document.getElementById('status').textContent = 'Error getting context: ' + (err && err.message ? err.message : 'Unknown error');
          console.error('Context Error:', err);
          
          // Fallback to empty form if we can't get user context
          const url = 'https://share.hsforms.com/1o9R-MCZ1S_iDscHC7T7krQc31ye';
          const iframe = document.createElement('iframe');
          iframe.src = url;
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';

          document.body.innerHTML = ''; // Clear status
          document.body.appendChild(iframe);
        });

        // Load form
        document.getElementById('status').textContent = 'Loading form...';
        const email = encodeURIComponent(context.user.userPrincipalName || '');
        const first = encodeURIComponent(context.user.givenName || '');
        const last = encodeURIComponent(context.user.surname || '');

        const url = `https://share.hsforms.com/1o9R-MCZ1S_iDscHC7T7krQc31ye?email=${email}&firstname=${first}&lastname=${last}`;
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';

        document.body.innerHTML = ''; // Clear status
        document.body.appendChild(iframe);
      } catch (err) {
        document.getElementById('status').textContent = 'Error initializing Teams SDK: ' + err.message;
        console.error('SDK Initialization Error:', err);
      }
    }

    // Initialize when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeTeamsApp);
  </script>
</body>
</html>
