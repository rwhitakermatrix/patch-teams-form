<!DOCTYPE html>
<html>
<head>
  <title>PATCH Form Debug</title>
  <meta charset="UTF-8" />
  <script src="https://statics.teams.cdn.office.net/sdk/v1.13.0/js/MicrosoftTeams.min.js"></script>
  <style>
    html, body, iframe {
      margin: 0; padding: 0; width: 100%; height: 100%; border: none;
    }
  </style>
</head>
<body>
  <div id="status">Loading Teams SDK...</div>
  <script>
    // Initialize the Teams app
    function initializeTeamsApp() {
      // Check if Teams SDK is loaded
      if (typeof microsoftTeams === 'undefined') {
        document.getElementById('status').textContent = 'Teams SDK not loaded';
        return;
      }

      try {
        // Initialize Teams SDK
        microsoftTeams.initialize();
        
        // Get context
        document.getElementById('status').textContent = 'Getting context...';
        
        // Get user context
        microsoftTeams.getContext().then((context) => {
          // Get user information
          const user = context.user || {};
          const email = encodeURIComponent(user.userPrincipalName || '');
          const first = encodeURIComponent(user.givenName || '');
          const last = encodeURIComponent(user.surname || '');

          // Load form with user info
          document.getElementById('status').textContent = 'Loading form...';
          loadForm(email, first, last);
        }).catch((err) => {
          document.getElementById('status').textContent = 'Error getting context: ' + (err && err.message ? err.message : 'Unknown error');
          console.error('Context Error:', err);
          
          // Fallback to empty form if we can't get user context
          loadForm();
        });
      } catch (err) {
        document.getElementById('status').textContent = 'Error initializing Teams SDK: ' + err.message;
        console.error('SDK Initialization Error:', err);
        loadForm(); // Load empty form as fallback
      }
    }

    // Initialize when the DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeTeamsApp);
  </script>
</body>
</html>
